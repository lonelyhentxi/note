# GAMES101-现代图形学入门笔记10-12：几何

该课程是 GAMES 开设的现代计算机图形学课程，系统而全面的介绍：光栅化、几何表示、光的传播理论、动画与模拟。每个方面都从基础原理出发讲解到实际应用，并介绍前沿的理论研究。本文是其 10-12 章几何的学习笔记。

<!--katex-->

## 1. 几何入门

### 几何的场景：

- 不同形状的组合
- 曲面的定义
- 大小和摆放
- 布料等复杂材料的几何
- 水滴等时序复杂物理现象的几何
- 巨型复杂场景的存储和渲染
- 小型复杂物体的表示和渲染
- 微观几何

### 隐式和显式

#### 隐式的几何

基于典型的点，点之间满足一些特定的关系，并不给出实际的点：

- 球，all points in 3D, where $x^2 + y^2 + z^2 = 1$
- 更通用地，$f(x,y,z)=0$

好处是方便判断点是否在面上/内/外，容易光线求交，有利于存储，描述上无采样错误，容易拓扑；坏处是难以判断形状是什么，难以使用规则的函数表示。

#### 显式的几何

最简单的理解是给出一些给定的点，定义一个几何体。另一种显式的方法是通过参数映射的方法。如：

$$
f(u,v) = ((2+\cos{u})\cos{v}, (2+\cos{u})\sin{v}, \sin{u})
\tag{1}
$$

如上式，采样非常简单，只要插入 $(u, v)$ 的值即可；判断点和表面的位置非常困难。

## 2. 隐式表达的方法

### 代数表面

表面是 $x$，$y$，$z$ 多项式的零集，如：

$$
x^2 + y^2 + z^2 = 1
\tag{2}
$$

$$
(R - \sqrt{x^2 + y^2})^2 + z^2 = r^2
\tag{3}
$$

$$
(x^2 + \frac{9 y^2}{4} + z^2 - 1)^3 = x^2 z^3 + \frac{9y^2 z^3}{80}
\tag{4}
$$

### 构造实体几何（Constructive Solid Geometry，CSG）

使用布尔操作结合隐式几何。

### 距离函数

对于任何一个点不描述其表面，而描述点到表面的最近距离。如混合一个移动边界。

距离函数恢复表面可以采用找零的方法。

### 水平集（Level Set Methods）

闭合形式的等式难以表述复杂的形状，作为替代地，可以存储一个值估计函数的网格。

表面被使用插值方法舍入后近似等于零的地方近似，提供了更加显式地控制。

水平集还可以应用在三维上，如医学数据（CT，MRI），该方法即为在三维上材质的表述。

水平集还能用来表示水滴的融合。

### 分型（Fractals）

自身的较小部分不断地重复组成类似的自身，类似递归。使用分形几何研究。部分情况下会引起渲染强烈地走样。

## 3. 显式几何的方法

### 点云

使用一堆点来表述物体，只要表示够细，就看不出是不连续的。其特点为：

- 易于表示任何种类的几何体
- 对大数据集非常有用
- 通常转换为多边形面
- 采样不足的地区难以绘制

### 多边形曲面

存储点和多边形，通常是以三角形和四边形的形式：

- 在图形学中应用广泛
- 易于处理、模拟、合适的采样
- 数据结构上更加复杂
- 最广泛的表示

PS：The Wavefront Object File（.obj）Format - 该格式仅仅是一种指明点、法线、材质、轴以及它们的连接的文本格式。

## 4. 曲线

典型的运用：

- 摄像机路径
- 动画曲线
- 向量字体（字体中加入控制点）

### 贝塞尔曲线（Bezier Curve）

贝塞尔曲线：用一系列控制点（Tangents）来定义曲线。

- 一定会经过起止点
- 起止方向与起止向量相切

#### 贝塞尔曲线估测 — de Casteljau 算法

(1) 二次

考虑三个点（二次贝塞尔曲线，quadratic bezier）, $b_0$ 、$b_1$ 和 $b_2$，其中，$b_0$ 和 $b_2$ 分别是起点和终点，$b_1$ 是控制点。

考虑一条时间轴 $0 -> 1$，$0$ 对应起点 $b_0$，$1$ 对应终点 $b_2$，要画出该曲线，要求画出任意时间点 $t$ 对应的点。

算法：连接 $b_0, b_1$ 和 $b_1, b_2$，得到两条线段。分别在线段上取 $t$ 分点，连接两个 $t$ 分点，得到一条新线段，再得到的线段上取 $t$ 分点，即为 $t$ 时间对应的点。

(3) 通用

考虑三个或者以上的点 $b_0, b_1, ..., b_n$，其中， $b_0, b_n$ 是起始点和终止点，其它点是控制点。对每组 $b_i, b_{i+1}$ 点形成的线段取每个时间点 $t$ 对应的分点，得到一组新的点集合。递归地进行该过程，直到剩下最后的点为 $t$ 时间对应的曲线点。连接所有 $t$ 时间对应的点，形成的曲线称之为 $n-1$ 次贝塞尔曲线。

[TODO IMAGE]()

#### 贝塞尔曲线的代数形式

(1) 二次

$$
\begin{aligned}
\vec{b}_0^1(t) &= (1 - t)\vec{b}_0 + t\vec{b}_1 \\
\vec{b}_1^2(t) &= (1 - t)\vec{b}_1 + t\vec{b}_2 \\
\vec{b}_0^2(t) &= (1 - t)\vec{b}_0^1 + t\vec{b}_1^2
\end{aligned}
$$

有

$$
\vec{b}_0^2(t) = (1 - t)^2 b_0 + 2t(1 - t)b_1 + t^2 b_2
$$

(2) 类似地，有

$$
\vec{b}^n(t) = \vec{b}_0^n(t) = \sum_{j=0}^n{\vec{b}_j B_j^n(t)}
$$

其中，使用了伯恩斯坦多项式 (Bernstein polynomials)

$$ \sum_{j=0}^n{\vec{b}_j B_j^n(t)} = \left( \begin{matrix} n \\ i \end{matrix} \right) t^i (1- t)^{n - i} $$

由于上述式中点坐标全都是向量形式，因此也能使用在三维坐标中，如下一个三维三次贝塞尔曲线


$$
\vec{b}_n(t) = \vec{b}_0 (1 - t)^3 + \vec{b}_1 3t(1-t)^2 + \vec{b}_2 3t^2(1-t) + \vec{b}_3 t^3
$$

#### 贝塞尔曲线的性质

1. 规定了必须过起点和终点，所以对于三次贝塞尔曲线： $\vec{b}(0) = \vec{b}_0$, $\vec{b}(1) = \vec{b}_3$
2. 对于三次贝塞尔曲线，起始和终止位置的切线规律：$\vec{b}'(0) = 3(\vec{b}_1 - \vec{b}_0), \vec{b}' = 3(\vec{b}_3 - \vec{b}_2)$
3. 仿射变换属性：
    - 对仿射变换后的顶点绘制贝塞尔曲线和对原始顶点绘制的贝塞尔曲线的每个点进行仿射变换，得出的贝塞尔曲线是相同的
    - 想要对贝塞尔曲线进行仿射变换，只要对其中的每个点进行仿射变换再绘制出一条贝塞尔曲线即可
4. 凸包性质（convex hull property）：
    - 性质：画出的曲线一定在所有的控制点形成的凸包内
    - 凸包：能够包围给定所有点的最小凸多边形

#### 逐段贝塞尔曲线（pairwise bezier curve）

概述：高阶贝塞尔曲线，难以利于使用中间控制点控制；通常，将 4 个点作为一组，即三次贝塞尔曲线，当起始点除的控制线连续则曲线平滑。

连续性：

- $C^0$ 连续：$\vec{a}_n = \vec{b}_0$
- $C^1$ 连续：$\vec{a}_n = \vec{b}_0 = \frac{1}{2}(\vec{a}_{n-1} + \vec{b}_1)$ 

### 其它类型的曲线

#### 样条曲线（Spline）

一条由经过的一系列点和一些列控制点构成的连续的曲线，在任意地方都满足一定的连续性

#### B-样条

- basis splines 基础样条
- 比贝塞尔曲线需要更多的信息
- 比贝塞尔曲线的能力更强，动其中的任意点，其它部分都会发生变化
- 想要拥有局部性，需要使用逐段贝塞尔曲线

#### NURBS 非均匀有理 B 样条

更复杂的样条

## 5. 面（suface）

### 贝塞尔曲面

#### 贝塞尔曲面基础

概念：拓展了贝塞尔曲线的定义

难点：如何保证严密接合

#### 贝塞尔曲面位置参数 $(u, v)$ 的估计

对于双方向的三次贝塞尔曲线，需要一个二维的控制时间坐标 $(u, v)$；类似三次贝塞尔曲线的 4 * 4 = 16 个控制点，首先从行的角度，将控制点四四分组，每四个点作一条贝塞尔曲线，将一个维度的时间 t 对应的四个点认为是另个方向的四个控制点绘制另一条贝塞尔曲线，绘制另一个维度时间轴的曲线，移动重复该过程则得到贝塞尔曲面。

### 网格（Mesh）操作：几何处理

基本操作：

1. 网格细分：Mesh subdivision —— 是一种超采样, upsampling
2. 网格化简：Mesh simplification —— 是一种降采样, downsampling
3. 网格正规化：Mesh regulation —— 去除特别尖锐奇特的三角形，编辑采样分布以提升质量

#### 细分

**(1) Loop Subdivsion**

注意：Loop 是一个人名

思路：1. 创建更多的三角形 2. 微调三角形的位置

方法：

- 拆分每个三角形为四个子三角形
- 通过权重，调整新三角顶点的位置 - 新老顶点分别来改变它们的位置
    - 对于新的顶点，以 $\frac{3}{8} * (A + B) + \frac{1}{8} * (C + D)$，其中 $A、B$ 是新顶点邻接的顶点，$C、D$ 是新顶点相对的非邻接点
    - 对于旧的顶点，以 $(1 - n * u) * original\_position + u * neighbor\_position\_sum$ 来更新，其中，$n$ 是顶点的度，$u\ =\ 3/16\ if\ n\ ==\ 3\ else\ 3/18n$

**(2) Catmull-Clark Subdivision 通用的网格**

特征：该方法可以用在非三角形的情况下使用

定义：

- 非四边形面, Non-quad face; 四边形面, Quad-face
- 奇异点，Extraordinary vertex，度不为四的点

步骤：

1. 在每个细分步骤中
    - 每个面添加一个顶点
    - 每条边添加中点
    - 连接所有的顶点
2. 在此次细分后的回顾：
    - 此时有以下问题
        - 有多少奇异点？在非四边形面内增加点并和每条边相连，因此，一定是奇异点
        - 这些奇异点的度是多少？是其多边形的边数
        - 多少个非四边形面？零个
    - 结论：该方法在经过一次细分后，会增加非四边形面数个奇异点，且由于已经全部是非四边形面，故奇异点数不会再增加
3. 更新公式，FYI，Catmull-Clark 顶点更新规则（四边形网格）
    - 对于新的位于四边形中间的顶点，更新规则为 $f = \frac{v_1 + v_2 + v_3 + v_4}{4}$，其中 $v_1 ... v_4$ 为四边形面的四个顶点
    - 对于新的位于边上的中间点，更新规则为 $e = \frac{v_1 + v_2 + f_1 + f_2}{4}$，其中 $v_1, v_2$ 为边的两个顶点，$f_1, f_2$ 为邻接的两个四边形面的顶点
    - 对于老的非奇异顶点，更新规则为 $v = \frac{f_1 + f_2 + f_3 + f_4 + 2(m_1 + m_2 + m_3 + m_4) + 4p}{16}$，其中 $f_1 ... f_4$ 为邻接面的新顶点，$m_1 ... m_4$ 为邻接边的新中间点，$p$ 为该点的旧位置

**收敛性**

形状会发生变化，且可能有折痕；相关结果有严密的理论证明

#### 曲面简化

目标：在保持整体形状的基础上减少网格元素的数量

**(1) 边坍缩 Collapsing An Edge**

概念：将一些边捏在一起

二次误差度量 Quadric Error Metrics

- 化简引入的几何误差的度量如何
- 顶点的局部平均不是一个好主意
- 二次误差度量：引入一个新的点可以最小化到过去相关的三角形面的距离平方和

边坍缩的二次误差

- 坍缩一条边的代价是？
- 想法：计算边的中点，测量二次误差
- 更好的想法：选择二次误差最小的点进行坍缩

核心算法 —— 迭代的边坍缩过程：

选取边的指标，为每条边赋予二次度量误差分数

- 由于每条边可能影响一组相关的边，因此可以使用堆的结构
- 迭代地坍缩最小分数的边
- 使用贪心算法 …… 能得到很好的结果