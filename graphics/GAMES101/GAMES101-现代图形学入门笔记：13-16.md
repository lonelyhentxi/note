# GAMES101-现代图形学入门笔记13-16：光线追踪

该课程是 GAMES 开设的现代计算机图形学课程，系统而全面的介绍：光栅化、几何表示、光的传播理论、动画与模拟。每个方面都从基础原理出发讲解到实际应用，并介绍前沿的理论研究。本文是其 13-16 章光线追踪的学习笔记。

## 1. 光线追踪概述

### 阴影 - Shadow Mapping

光栅化遇到的问题 —— 人们发明了在光栅化中绘制阴影的方法，称之为 Shadow mapping

#### 概述

本质上是一种图像空间的算法：
  - 在其阴影计算中不包含任何几何场景的信息
  - 必须处理采样偏倚

关键思想：如果点不在阴影中，却能够看到该点；说明摄像机可以 “看到” 这个点，同时光源也能够 “看到” 这个点

#### 步骤

- (1) 从光源看向场景：假设光源处有摄像机，进行光栅化，得到一幅深度阴影图像，无需进行着色
- (2A) 从摄像机看向场景：得到一副包含深度和色彩等的标准图像
- (2B) 投影到光源视角的场景：找到可视点对应光源视角场景的哪个像素上，如果深度一致则在阴影外，否则在阴影中

#### 问题

- 数值精度：在场景的各种距离涉及很多的浮点数，因此涉及精度问题 —— 考虑大小而非相等或者引入 bias，但不能完全解决问题
- 阴影走样：如果渲染的分辨率高，阴影的分辨率低，会引起阴影的走样
- 点光源和硬阴影：经典的 Shadow Mapping 只能处理点光源；“硬” 阴影：一个点要么在阴影里，要么不在阴影里的非 0 即 1 的过程

#### 光栅化阴影的改进

- 光栅化实现的软阴影：在物理上软阴影实际上是物理上的伴影，penumbra（反之为本影，umbra） —— 使用有大小的光源

### 光线追踪与光栅化

为什么要引入光线追踪？—— 光栅化无法很好地解决全局效果

- 软阴影
- 光泽反射，Glossy Reflection，在金属等表面反光但又不完全光滑的状态
- 间接光照，Indirect Illumination，光线在物体表面弹射不只一次

光栅化与光线追踪

- 光栅化是一种快速近似，但是质量相对较低，常被用来做实时应用
- 光线追踪是一种准确的方法，但是非常慢，常被用来做离线运算

## 2. 基础的光线追踪的方法

关于光线的三个基本观点（因为简化并不在物理上完全正确）：

- 光线是直线传播的
- 光线在相交时并不碰撞
- 光线从光源传播到摄像机

实际上，光线追踪运用了光线的可逆性；假设从摄像机传播出，反射到光源来进行计算

光线投射步骤：

1. 通过每像素投射一条光线的方法生成一副图像 - eye ray
    - eye ray 从摄像机开始发出，穿过每个像素
    - eye ray 和场景中最近的的交点相交，因此无需深度测试
2. 通过发射光线到光源的方法检查阴影 —— light ray
    - 从交点连接线到光源，如果没有被遮挡，就没有阴影
    - 由于可以有法线和反射角，可以使用布林冯模型进行着色计算

假设：

- 在一般的光线追踪中，总是认为眼睛是针孔摄像机
- 认为光线从眼睛射出到物体后，会按照镜面反射的方向射出

### 递归的光线追踪，Whitted-Style Ray Tracing

在每次反射时，可知反射强度和折射强度，不断重复该过程，直到能量小于某一阈值。在所有与场景的交点，都去进行和光源的连线，以计算着色和阴影。最后累加着色结果和阴影结果。

#### 光线-表面交点

光线公式：光线被定义为其起点和方向/光速向量 $\vec{r}(t) = \vec{o} + t\vec{d}, 0 \leq t \le \infty $

**和球的求交**

球公式：$\vec{p}: (\vec{p} - \vec{c})^2 - \vec{R}^2 = 0$

求解：

$$
\begin{aligned}
(\vec{o} + t\vec{d} - \vec{c})^2 - \vec{R}^2 &= 0 \\
\\
at^2 + bt + c &= 0, where \\
a &= \vec{d} \cdot \vec{d} \\
b &= 2 (\vec{o} - \vec{c}) \cdot \vec{d} \\
c &= (\vec{o} - \vec{c}) \cdot (\vec{o} - \vec{c}) - \vec{R}^2  \\
t &= \frac{ -b \pm \sqrt{ b^2 - 4ac } }{2a}
\end{aligned}
$$

**推广到一般的隐式表面**

一般的隐式表面：$\vec{p}: f(\vec{p}) = 0$

替换光线等式：$f(\vec{o} + t\vec{d}) = 0$

解出实数正根（数值方法）

**和三角网格求交**

理由：

- 渲染的：可见性、阴影、高光……
- 几何的：内部和外部测试 —— 发出的光线，如果与物体有奇数个交点，则在物体内；否则在物体外；切线切点由于是重根，视为两个交点

如何计算：

- 简单但是很慢的想法：一个个三角形进行计算交点
- 忽略多交点的情况，则只会有 0 或 1 的交点

计算方法：

- 光线和平面的求交
- 点是否在三角形内

光线和平面的求交：定义平面，定义一个法线及一个点  $\vec{p}: (\vec{p} - \vec{p}') * \vec{N} = 0\ 或\ ax + by + cz + d = 0$，其中 $\vec{N}$ 为其法线；解该交，设置 $\vec{p} = \vec{r}(t)$ 且解 $t$，有 $(\vec{p} - \vec{p}') \cdot \vec{N} = (\vec{o} + t \vec{d} - \vec{p}') \cdot \vec{N} = 0$，得 $t = \frac{(\vec{p}' - \vec{o}) \cdot \vec{N}}{\vec{d} \cdot \vec{N}}$，注意 $0 \leq t \le \infty$。

Moller Trumbore Algorithm，一种快速的方法，能够快速的计算三维光线和三角形交集，无需预计算包含三角形平面的平面方程。因为重心坐标法 ，有 $\vec{O} + t\vec{D} = (1 - b_1 - b_2)\vec{P}_0 + b_1\vec{P}_1 + b_2\vec{P}_2$ ，可得：

$$
\left[ \begin{matrix} t \\ b_1 \\ b_2 \end{matrix} \right] 
= \frac{1}{\vec{S}_1 \cdot \vec{E}_1} \left[ \begin{matrix} \vec{S}_2 \cdot \vec{E}_2 \\ \vec{S}_1 \cdot \vec{S} \\ \vec{S}_2 \cdot \vec{D} \end{matrix} \right]
$$

其中：

$$
\begin{aligned}
\vec{E}_1 &= \vec{P}_1 - \vec{P}_0 \\
\vec{E}_2 &= \vec{P}_2 - \vec{P}_0 \\
\vec{S} &= \vec{O} - \vec{P} \\
\vec{S}_1 &= \vec{D} \times \vec{E}_2 \\
\vec{S}_2 &= \vec{S} \times \vec{E}_1
\end{aligned}
$$

该式可通过克莱姆法则求解；计算代价为，1次除，27次乘，17次加。

#### 光线 - 表面求交加速

**性能的挑战**

简单的光线场景求交：

- 穷举测试每个对象的光线交点
- 找到最近的交点，最小的 t

问题：

- 原始的算法的规模 = $\$pixel\_num \times \$object\_num $
- 非常慢

通常地，后续使用术语“对象”而不是三角形，但并不意味着实体的对象

**Bounding Volumes 包围体积**

通过一个简单的体包围一个复杂的对象：

- 该对象被该体完全地包含
- 如果光线不与体相交，也就不会与对象相交
- 因此首先测试包围体再测试该对象

三维情况下最常用的形状是一个长方体，它能够被理解为三个不同的对面（pairs of slabs）形成的交集；通常用到的包围盒被称为轴对齐包围盒，Axis-Aligned Bouding Box，AABB，它沿着坐标轴。

光线和 AABB 求交：

- 先降低问题复杂性到 2D，可以求出和 $x$ 平面的交时间 $t_{x_{min}}$ 和 $t_{x_{max}}$，及和 $y$ 平面的交点 $t_{y_{min}}$ 和 $t_{y_{max}}$，有 $t_{enter} = \max{(t_{x_{min}}, t_{y_{min}})}, t_{exit} = \min{(t_{x_{max}}, t_{y_{max}})}$
- 拓展到 3D 问题，只有当 (1) 光线进入了盒子所有的对面 (2) 光线只要离开任意对面则就离开盒子；因此，对任意对面，计算 $t_{min}$ 和 $t_{max}$，有 $t_{enter} = \max{(t_{min})}, t_{exit} = \min{(t_{max})}$；如果 $t_{enter} < t_{exit}$ 说明光线必然在物体内交了一段时间
- 3D 问题的一些特殊情况：
    - 如果 $t_{exit} < 0$，说明盒子在光线的背后，没有交点；
    - 如果 $t_{exit} > 0, t_{enter} < 0$，说明光源本身在盒子内，必然和盒子有交点
    - 光线和盒子有交点当且经典 $t_{enter} < t_{exit}\ \&\&\ t_{exit} \geq 0$

为何使用轴对齐的？

- 通常情况下计算比较复杂
- 和轴对齐的情况下，单次计算是一维的，比较方便