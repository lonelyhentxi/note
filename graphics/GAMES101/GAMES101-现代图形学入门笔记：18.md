# GAMES101-现代图形学入门笔记18：渲染中的高级主题

该课程是 GAMES 开设的现代计算机图形学课程，系统而全面的介绍：光栅化、几何表示、光的传播理论、动画与模拟。每个方面都从基础原理出发讲解到实际应用，并介绍前沿的理论研究。本文是其 18 章渲染中的高级主题的学习笔记。

## 1. 高级光线传播

如果蒙特卡洛技术不会导致系统误差则称为无偏的：无偏估计器的预期值永远是正确的，无论其有多少采样；所有其它情况称之为有偏的：其中的一个特殊情况是，当采样率趋近到无穷时，其估计出的值趋近于正确值，则称为是一致的，Consistent。

### 无偏的的光线传输方法，Unbiased

#### 双向路径追踪，Bidirectional Path Tracing，BDPT

回顾：路径追踪中的路径连接了摄像机及光源

思想：

- 同时从摄像机和光源追踪子路径
- 从双向子路径连接终止点

优缺点：

- 如果从光源测光线传播非常复杂，则 BDPT 适用
- 难以实现且相当慢

#### Metropolis 光线传输，Metropolis Light Transport，MLT

思想：

- 使用马尔可夫链 Markov Chain Monte Carlo 进行链采样

优缺点：

- 当蒙特卡罗采样的 $f(x)$ 和 $p(x)$ 函数形状类似时，其效果最好；而 MLT 可以对任意形状函数生成一系列的样本，使得这些样本的分布和被积函数的形状一致。
- 是非常好局部地探索困难光路的方法
- 能够简单地通过扰动从已有的路径生成新的路径
- 难以在理论上分析其收敛速率
- 所有操作是局部的，有的收敛的快，有的慢，会导致看起来脏

### 有偏的光线传输方法，Biased

#### 光子映射，Photon mapping

概述：

- 一种有偏的两步方法
- 在处理高光漫反射高光，Specular-Diffuse-Specular，SDS 路径和生成焦散（causitics）时非常适合

一种实现：

1. 光子追踪：从光源发出很多光子，使它们碰撞，并记录光子停止于漫反射表面
2. 光子收集：从摄像机射出子路径，使他们碰撞，直到停止于漫反射表面
3. 计算 —— 局部密度估计：
    - 想法：有更多光子分布的区域，会越亮
    - 对于一个着色点，找到最近的 N 个光子

特性：

- 当 N 值低时，噪声高；当 N 值低时，会糊（blurry），相当于一个模糊滤波器 —— 有偏的
- 要想提升分辨率，最终还是需要提升光子数 —— 一致的
- 使用固定面积 —— 有偏但不一致

#### 顶点连接和合并，Vertex Connection and Mergig，VCM

想法：结合双向路径追踪和光子映射

- 不浪费 BDPT 中终止点未连接但是可以合并的双向路径
- 通过光子映射的方法来合并临近的 “光子”

### 实时辐射度算法，Instant radiosity，IR

#### VPL/Many Light

想法：被点亮的平面可以被认为是光源。

方法：

- 射出光子路径并认为其各自终点为虚拟点光源，Virtual Point Light，VPL
- 使用虚拟点光源去渲染场景

优缺点：

- 快速，且在漫反射时能给出很好的结果
- 不能处理光泽表面
- 当虚拟点光源距离着色点很近时，会出现亮点

## 2. 高级外观建模

### 非表面建模

#### 参与介质，Participating Media

典型案例：雾/云

概念：在某点处光线穿过一种参与介质，它能够部分地被吸收（absorbed）和散射（scattered）

分布：使用相位函数，Phase Function 来表述光线在散射介质某点处的散射产生的角度分布

渲染：

- 随机的选择某个方向被弹射
- 随机的选择距离来直线传播
- 在每个“着色点”处，连接光线

#### 头发/皮毛/纤维，Hair/Fur/Fiber，BCSDF

考虑纤维材质需要考虑光线和线的作用

Kajiya-Kay 模型：光线击中圆柱后，会散射出一个圆锥，同时也会有一些光线散射到四周 —— 类似高光和漫反射

Marschner 模型

- 光线击中头发后，一部分会被反射，称为 R；另一部分会穿入头发内再穿出，其中发生折射，称为 TT；还有一部分会发生折射、反射、折射，称之为 TRT
- 将头发视为一个类似玻璃的圆柱，外层有表皮 cuticle，内部有皮质 cortex —— 一种有色素的吸收素材

大量毛发纤维的渲染仍然是一大挑战

此外人的头发模型难以描述某些动物的毛发 —— 某些动物的毛发有较大的髓质 Medulla，其中包含复杂的结构；因此提出了双层圆柱模型，Double Cylinder Model，Lobes：

- 包含 R、TT、TRT，还包含在髓质中被散射到别处的 TTs 及在髓质处被全反射到外部的 TRTs

#### 颗粒材质，Granular Material

计算量过大，能否避免显示地为每个颗粒建模 —— 可以程序化地定义

目前来说并没有得到很好的解决

### 表面建模

#### 半透明材料，Translucent Material，BSSRDF

案例：玉石，Jade 和水母，Jellfish 都是典型的半透明材料

次表面反射：光线进入物体后，在物体内部发生多次散射后穿出；可以视为一种 BRDF 的延伸

BSSRDF：由 BRDF 生成，某点的离开辐射率取决于多个其它点的进入辐射率 $S(x_i, \omega_i, x_o, \omega_o)$；其渲染方程集成了表面的所有点和所有方向 $L(x_o, \omega_o) = \int_A{\int_{H^2}{S(x_i, \omega_i, x_o, \omega_o) L_i(x_i, \omega_i) \cos{\theta_i} d \omega_i dA}}$

由于计算复杂，可以使用 Dipole Approximation，将次表面散射近似为表面 - 内部两个光源

使用次表面散射渲染大理石、人的皮肤则会相对真实

#### 布料，Cloth

一系列缠绕的纤维 fiber 可以组成股 ply，一系列股经过缠绕会形成线 yarn，可以被编织 Woven 或者针织 Knitted 为布料

布料的表面渲染：给出编织模式，计算整体的行为，使用 BRDF 来渲染；该方法的限制无法模拟非平面结构。

布料作为参与介质渲染：

- 独立纤维的属性和它们的分布作为散射参数
- 作为参与介质渲染

布料作为实际纤维渲染：显式地渲染每根纤维

#### 细节度材质，Detailed/Glinty Material，Non-Statistical BRDF

真实世界中的材质会非常复杂，有各种小的纹路和瑕疵；有时需要加入一些瑕疵来使得其不完美。

在微表面模型中，使用更加复杂的分布函数描述其法线分布，就可以得到更好的结果。

但是使用路径追踪很难以渲染，因为很难以击中它们。因此可以计算一定范围内的微表面整体的法线分布综合起来，BRDF over pixel，考虑 p-NDFs 在不同尺度上，会有很多特殊的分布，且不同类型的法线贴图会引起不同的法线分布，只要能算出这些分布即可。实际海面的波纹也可以通过微表面分布进行计算。

近期的趋势：波动光学 —— 光盘/金属膜/手机屏幕；波动光学由于其干涉，会导致产生不连续的场景

### 程序化生成外观，Procedural Appearance

动机：能否无需材质的定义细节

- 可以使用噪声函数
- 噪声函数是定义在空间中

应用：

- 生成地形
- 生成工作台木头的三维纹理，可以任意切开